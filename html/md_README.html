<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JIT translator: Table of Contents</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">JIT translator
   </div>
   <div id="projectbrief">This is the documentation for this project. You can see the README in related projects.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Table of Contents </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>Introduction</li>
<li>About</li>
<li>Instruction table</li>
<li>Build</li>
<li>Usage</li>
<li>Testing</li>
</ul>
<h1><a class="anchor" id="autotoc_md1"></a>
Introduction &lt;a name="intro"&gt;&lt;/a&gt;</h1>
<p >This project is the final project in the 1st year of my university. I tried to collect everything I knew in this project. </p>
<h1><a class="anchor" id="autotoc_md2"></a>
About &lt;a name="about"&gt;&lt;/a&gt;</h1>
<p >This program is a binary translator that translates code generated by my own assembler language (look at the <a href="https://github.com/krisszzzz/proccessor">processor</a> repository) in x86 instructions. A binary translator is a program that translates executable files created on one architecture into an executable file created on another architecture. The simplest translator walks through the executable and translates each instruction into the corresponding instruction for another architecture. My translator translates the instructions and puts them in a buffer that is allocated in the C program. Further with the help of mprotect the buffer becomes executable, and code injection occurs. This principle is similar to the principle of JIT compilers, but such compilers are created for the purpose of dynamic (in real time) code optimization. I don't have this at the moment. Maybe I'll add it in the future. <br  />
</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Instruction table &lt;a name="instructions"&gt;&lt;/a&gt;</h1>
<p >Below you can see the table, that show how all instructions from my assembler translates into x86 instructions: <br  />
 </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">My assembler instructions   </th><th class="markdownTableHeadNone">x86 Intel instructions    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">push rax&lt;br&gt;(push register)   </td><td class="markdownTableBodyNone">movq qword [rsp], xmm1<br  />
sub rsp, 8    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">push [0]<br  />
(push value from memory)   </td><td class="markdownTableBodyNone">vmovq xmm5, qword [r13 + 8 * 0] ; r13 contain the buffer address begin<br  />
vmovq qword [rsp], xmm5<br  />
sub rsp, 8    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">push 1<br  />
(push immediate value)   </td><td class="markdownTableBodyNone">movabs r14, 0x3ff0000000000000 ; r14 used as a temp<br  />
mov qword [rsp], r14<br  />
sub rsp, 8    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">pop rax&lt;br&gt;(pop value to register)   </td><td class="markdownTableBodyNone">vmovq xmm1, qword [rsp + 8]<br  />
add rsp, 8    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">pop [0]<br  />
(pop value to memory)   </td><td class="markdownTableBodyNone">vmovq xmm5, qword [rsp + 8]<br  />
vmovq qword [r13 + 8 * 0], xmm5<br  />
add rsp, 8    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">pop&lt;br&gt;(pop value without destination)   </td><td class="markdownTableBodyNone">add rsp, 8    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">add; sub; mul; div&lt;br&gt;(do arithmetic operation using value from stack)   </td><td class="markdownTableBodyNone">vmovq xmm5, qword [rsp+8]<br  />
addsd; subsd; mulsd; divsd xmm5, qword [rsp+16]<br  />
add rsp, 8    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">jmp :Label&lt;br&gt;(jump to label)   </td><td class="markdownTableBodyNone">jml rel32    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">je :Label ; ja :Label; jb :Label&lt;br&gt;(conditionally jump to label, compare two value&lt;br&gt;from stack)   </td><td class="markdownTableBodyNone">vmovq xmm0, qword [rsp+8]<br  />
vmovq xmm5, qword [rsp+16]<br  />
add rsp, 16<br  />
<br  />
vcmppd xmm5, xmm0, xmm5, 0 (in je case) ;<br  />
vcmppd xmm5, xmm0, xmm5, 0x1E (in ja case) ;<br  />
vcmppd xmm5, xmm0, xmm5, 0x11 (in jb case)<br  />
movmskpd r14d, xmm5<br  />
cmp r14d, 0x3 (in je case)<br  />
cmp r14d, 0x1 (in ja and jb case)<br  />
je rel32&lt;br&gt;<br  />
(0x3 = 00000011b - the first bit is set if the lower value in xmm5 equal to<br  />
 lower value of xmm0. But because the higher value of all xmm registers we zeroed<br  />
 the second bit always will be set in je case. But it is not correct to ja and jb,<br  />
 so the mask for ja and jb just 0x1 = 00000001b)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">call :Label&lt;br&gt;(jump to label and push the return address to &lt;br&gt;the stack)   </td><td class="markdownTableBodyNone">mov [rsp], ret_address<br  />
sub rsp, 16; (align stack to avoid segfault)<br  />
jmp rel32    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ret&lt;br&gt;(return to address in top of the stack)   </td><td class="markdownTableBodyNone">add rsp, 8 ; (Require because of alignment)<br  />
ret    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">hlt&lt;br&gt;(end the program)   </td><td class="markdownTableBodyNone">mov rsp, rbp ; (Restore the rsp value saved in the beginning)<br  />
ret    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">sqrt&lt;br&gt;(take root from the top value of stack)   </td><td class="markdownTableBodyNone">vmovq xmm0, qword [rsp+8]<br  />
vsqrtpd xmm0, xmm0<br  />
vmovq [rsp+8], xmm0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">out&lt;br&gt;(output double precision float value using printf)   </td><td class="markdownTableBodyNone">lea rdi, [rsp + 8] ; Set the address of float value that will be outputed&lt;br&gt;<br  />
vmovq qword [rsp], xmm1<br  />
sub rsp, 8<br  />
vmovq qword [rsp], xmm2<br  />
sub rsp, 8<br  />
vmovq qword [rsp], xmm3<br  />
sub rsp, 8<br  />
vmovq qword [rsp], xmm4<br  />
sub rsp, 8<br  />
; Save all register<br  />
call double_printf ; Calls a printf wrapper that prints a floating point number.<br  />
 ; See the documentation<br  />
vmovq xmm4, qword [rsp+8]<br  />
add rsp, 8<br  />
vmovq xmm4, qword [rsp+8]<br  />
add rsp, 8<br  />
vmovq xmm4, qword [rsp+8]<br  />
add rsp, 8<br  />
vmovq xmm4, qword [rsp+8]<br  />
add rsp, 8<br  />
; Restore all register    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">in&lt;br&gt;(input double precision float value using scanf)   </td><td class="markdownTableBodyNone">mov rdi, rsp ; Set the address of floating value that will be inputed<br  />
call double_scanf ; Calls a scanf wrapper that take a floating point number.<br  />
 ; See the documentation<br  />
sub rsp, 8   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md4"></a>
Build &lt;a name="build"&gt;&lt;/a&gt;</h1>
<div class="fragment"><div class="line">git clone https://</div>
<div class="line">cd ~/Binary_Translator</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake ..</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
Usage &lt;a name="usage"&gt;&lt;/a&gt;</h1>
<p >Please go to the processor repository and read more info about usage of my <a href="https://github.com/krisszzzz/proccessor">assembler language</a> <br  />
 Make an executable to my own processor. <br  />
</p>
<p >In <em>Binary Traslator</em> directory: <br  />
 Traslate executable and natively (on x86 Intel) execute the translated program: </p><div class="fragment"><div class="line">./BT /path_to_file/</div>
</div><!-- fragment --><p >Execute the file in non-native processor (emulator wrotten by me): </p><div class="fragment"><div class="line">./BT --non-native /path_to_file/</div>
</div><!-- fragment --><p >Write the execution and (in native mode) translation time: </p><div class="fragment"><div class="line">./BT --time /path_to_file/</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Testing &lt;a name="testing"&gt;&lt;/a&gt;</h1>
<p >I wrote I simple program in my assembler that count the factorial of number 50 10000 times and compare native and non-native execution. <br  />
 <details>
</details>
</p>
<p ><details>
<summary>Source code</summary></details>
</p>
<p ><details>
</p><div class="fragment"><div class="line">:5</div>
<div class="line">push 50</div>
<div class="line">pop ax</div>
<div class="line"> </div>
<div class="line">push 0</div>
<div class="line">pop bx</div>
<div class="line"> </div>
<div class="line">push 1</div>
<div class="line">pop [0]</div>
<div class="line"> </div>
<div class="line">:3</div>
<div class="line">push bx</div>
<div class="line">push 1</div>
<div class="line">add</div>
<div class="line">pop bx</div>
<div class="line">push bx</div>
<div class="line">push bx</div>
<div class="line"> </div>
<div class="line">push [0]</div>
<div class="line">mul</div>
<div class="line">pop [0]</div>
<div class="line"> </div>
<div class="line">push ax</div>
<div class="line">ja :3</div>
<div class="line"> </div>
<div class="line">push cx</div>
<div class="line">push 1</div>
<div class="line">add</div>
<div class="line">pop cx</div>
<div class="line">push cx</div>
<div class="line">push 10000</div>
<div class="line">ja :5</div>
<div class="line"> </div>
<div class="line">push [0]</div>
<div class="line">out</div>
<div class="line">hlt </div>
</div><!-- fragment --><p> </details>
 </p>
<p >Everywhere I used following flags: <br  />
 </p><div class="fragment"><div class="line">gcc -D NDEBUG -Ofast -mavx2 </div>
</div><!-- fragment --><p >Results: <br  />
 </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Emulator   </th><th class="markdownTableHeadNone">Native    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2810 ms   </td><td class="markdownTableBodyNone">4 ms   </td></tr>
</table>
<p >Accelaration is about 700 times. <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
